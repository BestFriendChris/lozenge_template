package tokenizer

import (
	"github.com/BestFriendChris/go-ic/ic"
	"testing"
)

func TestContentTokenizer_NextToken(t *testing.T) {
	t.Run("happy path", func(t *testing.T) {
		rest := `
Try:
◊^{ import "fmt" }
◊{ v := 1 }
v = ◊v ◊
	  1 + 2 = ◊(1 + 2)
◊.CustomFoo
DONE
`[1:]

		tokens := make([]*Token, 0)
		var token *Token
		tokenizer := NewDefault()
		for {
			token, rest = tokenizer.NextToken(rest)
			tokens = append(tokens, token)
			if rest == "" {
				break
			}
		}

		c := ic.New(t)
		c.PT(tokens)
		c.Expect(`
			   | TT                   | S                  | E |
			---+----------------------+--------------------+---+
			 1 | TT.Content           | "Try:"             |   |
			---+----------------------+--------------------+---+
			 2 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			 3 | TT.GoCodeGlobalBlock | " import \"fmt\" " |   |
			---+----------------------+--------------------+---+
			 4 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			 5 | TT.GoCodeLocalBlock  | " v := 1 "         |   |
			---+----------------------+--------------------+---+
			 6 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			 7 | TT.Content           | "v"                |   |
			---+----------------------+--------------------+---+
			 8 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			 9 | TT.Content           | "="                |   |
			---+----------------------+--------------------+---+
			10 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			11 | TT.GoCodeExpr        | "v"                |   |
			---+----------------------+--------------------+---+
			12 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			13 | TT.Content           | "◊"                |   |
			---+----------------------+--------------------+---+
			14 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			15 | TT.WS                | "\t  "             |   |
			---+----------------------+--------------------+---+
			16 | TT.Content           | "1"                |   |
			---+----------------------+--------------------+---+
			17 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			18 | TT.Content           | "+"                |   |
			---+----------------------+--------------------+---+
			19 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			20 | TT.Content           | "2"                |   |
			---+----------------------+--------------------+---+
			21 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			22 | TT.Content           | "="                |   |
			---+----------------------+--------------------+---+
			23 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			24 | TT.GoCodeExpr        | "(1 + 2)"          |   |
			---+----------------------+--------------------+---+
			25 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			26 | TT.Macro             | "CustomFoo"        |   |
			---+----------------------+--------------------+---+
			27 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			28 | TT.Content           | "DONE"             |   |
			---+----------------------+--------------------+---+
			29 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			`)
	})
	t.Run("happy path (change loz)", func(t *testing.T) {
		rest := `
Try:
^^{ import "fmt" }
^{ v := 1 }
v = ^v ^
	  1 + 2 = ^(1 + 2)
^.CustomFoo
DONE
`[1:]

		tokens := make([]*Token, 0)
		var token *Token
		tokenizer := New('^')
		for {
			token, rest = tokenizer.NextToken(rest)
			tokens = append(tokens, token)
			if rest == "" {
				break
			}
		}

		c := ic.New(t)
		c.PT(tokens)
		c.Expect(`
			   | TT                   | S                  | E |
			---+----------------------+--------------------+---+
			 1 | TT.Content           | "Try:"             |   |
			---+----------------------+--------------------+---+
			 2 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			 3 | TT.GoCodeGlobalBlock | " import \"fmt\" " |   |
			---+----------------------+--------------------+---+
			 4 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			 5 | TT.GoCodeLocalBlock  | " v := 1 "         |   |
			---+----------------------+--------------------+---+
			 6 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			 7 | TT.Content           | "v"                |   |
			---+----------------------+--------------------+---+
			 8 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			 9 | TT.Content           | "="                |   |
			---+----------------------+--------------------+---+
			10 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			11 | TT.GoCodeExpr        | "v"                |   |
			---+----------------------+--------------------+---+
			12 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			13 | TT.Content           | "^"                |   |
			---+----------------------+--------------------+---+
			14 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			15 | TT.WS                | "\t  "             |   |
			---+----------------------+--------------------+---+
			16 | TT.Content           | "1"                |   |
			---+----------------------+--------------------+---+
			17 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			18 | TT.Content           | "+"                |   |
			---+----------------------+--------------------+---+
			19 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			20 | TT.Content           | "2"                |   |
			---+----------------------+--------------------+---+
			21 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			22 | TT.Content           | "="                |   |
			---+----------------------+--------------------+---+
			23 | TT.WS                | " "                |   |
			---+----------------------+--------------------+---+
			24 | TT.GoCodeExpr        | "(1 + 2)"          |   |
			---+----------------------+--------------------+---+
			25 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			26 | TT.Macro             | "CustomFoo"        |   |
			---+----------------------+--------------------+---+
			27 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			28 | TT.Content           | "DONE"             |   |
			---+----------------------+--------------------+---+
			29 | TT.NL                | "\n"               |   |
			---+----------------------+--------------------+---+
			`)
	})
	t.Run("whitespace", func(t *testing.T) {
		token, rest := readNextToken("\t   hi")

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.WS
			Token.S: "\t   "
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"hi"
			`)
	})
	t.Run("newline", func(t *testing.T) {
		token, rest := readNextToken("\n\nfoo")

		c := ic.New(t)
		c.Println("Only read one newline")
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			Only read one newline
			################################################################################
			# token
			################################################################################
			Token.TT: TT.NL
			Token.S: "\n"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"\nfoo"
			`)
	})
	t.Run("content", func(t *testing.T) {
		token, rest := readNextToken("foo\nbar")

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "foo"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"\nbar"
			`)
	})
	t.Run("◊◊foo", func(t *testing.T) {
		token, rest := readNextToken(`◊◊foo`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "◊"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"foo"
			`)
	})
	t.Run("◊ bar", func(t *testing.T) {
		token, rest := readNextToken(`◊ bar`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "◊"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			" bar"
			`)
	})
	t.Run(`◊\nbar`, func(t *testing.T) {
		token, rest := readNextToken("◊\nbar")

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "◊"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"\nbar"
			`)
	})
	t.Run(`◊`, func(t *testing.T) {
		token, rest := readNextToken("◊")

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "◊"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			""
			`)
	})
	t.Run("◊foo bar", func(t *testing.T) {
		token, rest := readNextToken(`◊foo bar`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.GoCodeExpr
			Token.S: "foo"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			" bar"
			`)
	})
	t.Run("◊foo", func(t *testing.T) {
		token, rest := readNextToken(`◊foo`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.GoCodeExpr
			Token.S: "foo"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			""
			`)
	})
	t.Run("◊(1 + 2)foo", func(t *testing.T) {
		token, rest := readNextToken(`◊(1 + 2)foo`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.GoCodeExpr
			Token.S: "(1 + 2)"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"foo"
			`)
	})
	t.Run("◊(1 + 2", func(t *testing.T) {
		token, rest := readNextToken(`◊(1 + 2`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "◊"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"(1 + 2"
			`)
	})
	t.Run("◊{ GOCODE }", func(t *testing.T) {
		token, rest := readNextToken("◊{ var foo struct{a string}{\"}\\\"\"} }foo")

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.GoCodeLocalBlock
			Token.S: " var foo struct{a string}{\"}\\\"\"} "
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"foo"
			`)
	})
	t.Run("◊{ GOCODE ", func(t *testing.T) {
		token, rest := readNextToken(`◊{ var foo struct{a string}{"}"} foo`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "◊"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"{ var foo struct{a string}{\"}\"} foo"
			`)
	})
	t.Run("◊^{ GOCODE }", func(t *testing.T) {
		token, rest := readNextToken(`
◊^{
	type foo struct{
		a string
	}
}foo`[1:])

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.GoCodeGlobalBlock
			Token.S: "\n\ttype foo struct{\n\t\ta string\n\t}\n"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"foo"
			`)
	})
	t.Run("◊^{ GOCODE ", func(t *testing.T) {
		token, rest := readNextToken(`
◊^{
	type foo struct{
		a string
	}
foo`[1:])

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "◊"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"{\n\ttype foo struct{\n\t\ta string\n\t}\nfoo"
			`)
	})
	t.Run("◊^foo", func(t *testing.T) {
		token, rest := readNextToken(`◊^foo`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Content
			Token.S: "◊"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			"^foo"
			`)
	})
	t.Run("◊.macro foo", func(t *testing.T) {
		token, rest := readNextToken(`◊.macro foo`)

		c := ic.New(t)
		logToken(c, token)
		logRest(c, rest)
		c.Expect(`
			################################################################################
			# token
			################################################################################
			Token.TT: TT.Macro
			Token.S: "macro"
			Token.E: 
			################################################################################
			# rest
			################################################################################
			" foo"
			`)
	})
}

func readNextToken(s string) (*Token, string) {
	tokenizer := NewDefault()
	return tokenizer.NextToken(s)
}

func logToken(c *ic.IC, t *Token) {
	c.PrintSection("token")
	c.PV(t)
}

func logRest(c *ic.IC, rest string) {
	c.PrintSection("rest")
	c.Printf("%q\n", rest)
}
